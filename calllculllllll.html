if (!allowed(ns)) throw 'bad';
      return Function('return(' + ns + ')')();
    }

    function splitByLastOp(s) {
      let depth = 0, pos = -1, op = null;
      for (let i = 0; i < s.length; i++) {
        const c = s[i];
        if (c === '(') depth++;
        else if (c === ')') depth--;
        else if (depth === 0 && '+-*/'.includes(c)) {
          pos = i; op = c;
        }
      }
      return pos >= 0 ? { left: s.slice(0, pos), op, right: s.slice(pos + 1) } : null;
    }

    function applyPercent() {
      const parts = splitByLastOp(expr);
      if (!parts) {
        if (!expr.trim()) return;
        expr = (${expr}/100);
        show();
        return;
      }
      const { left, op, right } = parts;
      if (!right.trim()) return;
      try {
        const A = safeEval(left);
        const B = safeEval(right);
        let replacement;
        if (op === '+' || op === '-') {
          replacement = (${left})${op}(((${left})*(${B})/100));
        } else if (op === '*') {
          replacement = (${left})*(${B}/100);
        } else {
          replacement = (${left})/(${B}/100);
        }
        expr = replacement;
        show();
        resEl.textContent = fmt(safeEval(expr));
      } catch {
        resEl.textContent = 'Ошибка';
      }
    }

    function calculate() {
      try {
        resEl.textContent = fmt(safeEval(expr));
      } catch {
        resEl.textContent = 'Ошибка';
      }
    }

    function press(k) {
      if (k === '=') return calculate();
      if (k === 'C') { expr = ""; resEl.textContent = "0"; show(); return; }
      if (k === 'back') { expr = expr.slice(0, -1); show(); return; }
      if (k === 'sqrt') { expr += '√('; show(); return; }
      if (k === '%') return applyPercent();
      expr += k;
      show();
    }

    keys.addEventListener('click', e => {
      const b = e.target.closest('button');
      if (!b) return;
      press(b.dataset.k);
    });
    window.addEventListener('keydown', e => {
      const m = { Enter: '=', Backspace: 'back', Escape: 'C' };
      let k = m[e.key] ?? e.key;
      if ('0123456789.+-*/()^'.includes(k) || ['=', 'back', 'C', '%'].includes(k)) {
        press(k);
      }
    });

    show();
  </script>
</body>
</html>
