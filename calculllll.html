for(let i=0;i<s.length;i++){
        const c=s[i];
        if(c==='(') depth++;
        else if(c===')') depth=Math.max(0,depth-1);
        else if(depth===0 && '+-*/'.includes(c)){
          pos=i; op=c; // берём самый правый
        }
      }
      if(pos===-1) return null;
      return {left:s.slice(0,pos), op, right:s.slice(pos+1)};
    }

    // Реализация процента «как в инженерных»
    function applyPercent(){
      const parts = splitByLastOp(expr);
      if(!parts){
        // Одиночное число: N% -> (N/100)
        if(!expr.trim()) return;
        expr = (${expr}/100);
        show(); return;
      }
      const {left, op, right} = parts;
      // Если правая часть пуста – нечего переводить
      if(!right.trim()) return;

      try{
        const A = safeEval(left);
        const B = safeEval(right);

        let replacement;
        if(op==='+' || op==='-'){
          replacement = (${left})${op}(((${left})*(${B})/100));
        }else if(op==='*'){
          replacement = (${left})*(${B}/100);
        }else{ // '/'
          replacement = (${left})/(${B}/100);
        }
        expr = replacement;
        show();
        resEl.textContent = fmt(safeEval(expr));
      }catch(_){ resEl.textContent='Ошибка'; }
    }

    function calculate(){
      try{
        resEl.textContent = fmt(safeEval(expr));
      }catch(_){ resEl.textContent='Ошибка'; }
    }

    function press(k){
      if(k==='='){ calculate(); return; }
      if(k==='C'){ expr=''; resEl.textContent='0'; show(); return; }
      if(k==='back'){ expr = expr.slice(0,-1); show(); return; }
      if(k==='sqrt'){ expr += '√('; show(); return; }
      if(k==='%'){ applyPercent(); return; }
      expr += k; show();
    }

    keys.addEventListener('click', e=>{
      const b=e.target.closest('button'); if(!b) return;
      press(b.dataset.k);
    });
    window.addEventListener('keydown', e=>{
      const map = {Enter:'=', Backspace:'back', Escape:'C'};
      let k = map[e.key] ?? e.key;
      if('0123456789.+-*/()^'.includes(k)) press(k);
      else if(['=','back','C'].includes(k)) press(k);
      else if(e.key === '%') press('%');
    });

    show();
  </script>
</body>
</html>
